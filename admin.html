<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin | Made With Love</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); min-height: 100vh; color: #4a4a4a; overflow-x: hidden; }
        .liquid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 15% 50%, rgba(255, 182, 193, 0.4), transparent 25%), radial-gradient(circle at 85% 30%, rgba(173, 216, 230, 0.4), transparent 25%); filter: blur(30px); }
        .glass-panel { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .glass-input { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 16px; padding: 15px; width: 100%; outline: none; transition: 0.3s; font-size: 16px; /* Prevent Zoom on iOS */ }
        .glass-input:focus { background: rgba(255, 255, 255, 0.9); border-color: #ffb6c1; }
        .liquid-btn { background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%); border: none; border-radius: 16px; color: white; font-weight: 700; padding: 15px; cursor: pointer; transition: 0.2s; text-transform: uppercase; width: 100%; }
        .liquid-btn:active { transform: scale(0.98); }
        
        /* Modal Fixes for Mobile */
        .info-modal { background: rgba(255, 255, 255, 0.98); border-radius: 24px; max-height: 85vh; overflow-y: auto; border: 2px solid #fff0f5; -webkit-overflow-scrolling: touch; }
        .info-label { font-size: 0.65rem; font-weight: 800; color: #ff9a9e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .info-value { font-size: 0.9rem; color: #333; background: #f4f4f4; padding: 10px; border-radius: 10px; word-break: break-word; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="liquid-bg"></div>

    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-white/30 backdrop-blur-md p-4">
        <div class="glass-panel p-8 w-full max-w-sm text-center">
            <img src="logo.png" class="h-20 mx-auto mb-4 drop-shadow-lg">
            <h2 class="text-xl font-bold mb-6 text-gray-700 tracking-wide">ADMIN ACCESS</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Identifier" class="glass-input">
                <input type="password" id="pass" placeholder="Passcode" class="glass-input">
                <button onclick="login()" class="liquid-btn">Enter System</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden max-w-[90rem] mx-auto pb-20">
        <nav class="glass-panel px-6 py-4 mb-6 flex justify-between items-center sticky top-2 z-40">
            <div class="flex items-center gap-2"><img src="logo.png" class="h-8"><span class="font-bold text-lg text-gray-600">ADMIN</span></div>
            <button onclick="logout()" class="text-xs font-bold text-red-400 border border-red-200 px-3 py-2 rounded-full">LOGOUT</button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="glass-panel p-6 h-fit lg:col-span-1 order-1">
                <h3 class="text-lg font-bold mb-4 text-gray-600 flex items-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> NEW ITEM</h3>
                <div class="space-y-4">
                    <div><select id="prodCategory" class="glass-input"><option value="Cake">Cake (Fresh)</option><option value="Real Flower">Real Flower</option><option value="Dried Flower">Dried / Soap Flower</option></select></div>
                    <div><input type="text" id="orderCode" class="glass-input" placeholder="Order Code (e.g. C-001)"></div>
                    <div><input type="text" id="prodCaption" class="glass-input" placeholder="Item Name"></div>
                    <div class="relative group">
                        <input type="file" id="prodImg" class="hidden" onchange="document.getElementById('fileLabel').innerHTML = '<i class=\'fa-solid fa-check text-green-500\'></i> ' + this.files[0].name">
                        <label for="prodImg" id="fileLabel" class="glass-input border-dashed border-2 text-center block py-6 text-gray-400 cursor-pointer"><i class="fa-regular fa-image text-xl mb-1"></i><br>Choose Image</label>
                    </div>
                    <button onclick="uploadProduct()" id="uploadBtn" class="liquid-btn">PUBLISH</button>
                </div>
            </div>

            <div class="glass-panel p-6 lg:col-span-3 order-2 overflow-hidden">
                <h3 class="text-lg font-bold mb-4 text-gray-600 flex items-center gap-2"><i class="fa-solid fa-list"></i> ORDERS</h3>
                <div class="overflow-x-auto rounded-xl pb-2">
                    <table class="w-full text-left border-collapse whitespace-nowrap min-w-[600px]">
                        <thead class="bg-white/40 text-gray-500 text-xs uppercase tracking-wider border-b border-white/30">
                            <tr>
                                <th class="p-3">Time</th>
                                <th class="p-3">Code / Item</th>
                                <th class="p-3">Customer</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 text-center">Details</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="text-sm divide-y divide-white/30 text-gray-600"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="info-modal w-full md:max-w-3xl p-6 relative animate-slide-up md:animate-fade-in rounded-t-3xl md:rounded-3xl h-[90vh] md:h-auto">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-500 z-10"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2 sticky top-0 bg-white/90 p-2 backdrop-blur-sm z-0">
                <i class="fa-solid fa-file-invoice text-pink-400"></i> Order Info
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
                <div class="space-y-4">
                    <div class="bg-pink-50 p-4 rounded-xl border border-pink-100">
                        <div class="grid grid-cols-2 gap-3">
                            <div><span class="info-label">Code</span><div class="info-value" id="d-code"></div></div>
                            <div><span class="info-label">Type</span><div class="info-value" id="d-cat"></div></div>
                            <div class="col-span-2"><span class="info-label">Item</span><div class="info-value" id="d-name"></div></div>
                            <div class="col-span-2"><span class="info-label">Selection</span><div class="info-value" id="d-select"></div></div>
                            <div class="col-span-2"><span class="info-label">Total Amount</span><div class="info-value font-bold text-pink-600 text-lg" id="d-total"></div></div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div class="space-y-3">
                            <div><span class="info-label text-blue-400">Sender</span><div class="info-value" id="d-sender"></div></div>
                            <div><span class="info-label text-blue-400">Receiver</span><div class="info-value" id="d-receiver"></div></div>
                        </div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <div class="space-y-3">
                            <div><span class="info-label text-purple-400">Address</span><div class="info-value whitespace-normal" id="d-addr"></div></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><span class="info-label text-purple-400">Date</span><div class="info-value" id="d-date"></div></div>
                                <div><span class="info-label text-purple-400">Time</span><div class="info-value" id="d-time"></div></div>
                            </div>
                            <div><span class="info-label text-purple-400">Message</span><div class="info-value italic text-gray-500 whitespace-normal" id="d-msg"></div></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <span class="info-label mb-1">Payment Slip</span>
                        <img id="d-img-receipt" class="w-full h-48 object-contain rounded-xl border bg-gray-100 cursor-pointer" onclick="window.open(this.src)">
                        <a id="d-download-btn" href="#" target="_blank" class="block w-full text-center bg-gray-800 text-white py-3 rounded-xl font-bold mt-2 text-sm"><i class="fa-solid fa-download mr-2"></i> Download Slip</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const config = { apiKey: "AIzaSyD6txNwU9zsYWeDjrSTf25k20ZgZA0CBGc", authDomain: "made-with-love-by-me-2dee6.firebaseapp.com", projectId: "made-with-love-by-me-2dee6", appId: "1:100906722681:web:80dc4caec22a2dae91fba8" };
        const app = initializeApp(config); const auth = getAuth(app); const db = getFirestore(app);
        const IMGBB_API_KEY = "80b5e4d996c2c5e93df3349eea5c77f8";
        let ordersData = {};

        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); } catch(e) { alert("Access Denied"); } };
        window.logout = () => signOut(auth);
        onAuthStateChanged(auth, user => { document.getElementById('login-view').classList.toggle('hidden', !!user); document.getElementById('dashboard-view').classList.toggle('hidden', !user); if(user) startListener(); });

        window.uploadProduct = async () => {
            const cat = document.getElementById('prodCategory').value;
            const code = document.getElementById('orderCode').value;
            const caption = document.getElementById('prodCaption').value;
            const file = document.getElementById('prodImg').files[0];
            if(!code || !caption || !file) return alert("Missing Info");
            
            const btn = document.getElementById('uploadBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> UPLOADING...'; btn.disabled = true;
            let hiddenSize = cat === 'Real Flower' ? '100' : (cat === 'Dried Flower' ? '60' : '80');

            try {
                const formData = new FormData(); formData.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await res.json();
                await addDoc(collection(db, "products"), { category: cat, shipSize: hiddenSize, orderCode: code, caption: caption, imageUrl: data.data.url, createdAt: new Date().toISOString() });
                alert("Done!");
                document.getElementById('orderCode').value = ""; document.getElementById('prodCaption').value = ""; document.getElementById('fileLabel').innerHTML = 'Choose Image';
            } catch(e) { alert("Error"); }
            btn.innerText = "PUBLISH"; btn.disabled = false;
        };

        function startListener() {
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snap => {
                const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
                ordersData = {}; 
                snap.forEach(d => {
                    const data = d.data();
                    ordersData[d.id] = data;
                    let badge = data.status === 'Approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                    let btn = data.status === 'Pending' ? `<button onclick="approve('${d.id}')" class="bg-green-500 text-white px-3 py-1 rounded-full text-xs shadow-sm">✓</button>` : '';
                    let displayCode = data.orderCode || "N/A";
                    let displayCaption = data.caption || data.productName || "Product";
                    let customerName = data.sender ? data.sender.name : (data.customer ? data.customer.name : "-");

                    tbody.innerHTML += `
                        <tr class="hover:bg-white/30 transition border-b border-white/20">
                            <td class="p-3 text-xs opacity-60">${new Date(data.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                            <td class="p-3">
                                <span class="font-bold text-gray-800 block text-xs">[${displayCode}]</span>
                                <span class="text-xs text-gray-500 truncate block max-w-[100px]">${displayCaption}</span>
                            </td>
                            <td class="p-3 text-sm font-bold text-gray-600">${customerName}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${badge}">${data.status}</span></td>
                            <td class="p-3 text-center"><button onclick="viewDetails('${d.id}')" class="bg-blue-100 text-blue-600 p-2 rounded-full text-xs"><i class="fa-solid fa-eye"></i></button></td>
                            <td class="p-3 text-right flex justify-end gap-2">${btn}<button onclick="del('${d.id}')" class="text-red-300 px-2"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>`;
                });
            });
        }

        window.viewDetails = (id) => {
            const data = ordersData[id]; if (!data) return;
            document.getElementById('d-code').innerText = data.orderCode || "N/A";
            document.getElementById('d-cat').innerText = data.category;
            document.getElementById('d-name').innerText = data.caption || data.productName;
            document.getElementById('d-select').innerText = data.category === 'Cake' ? `${data.size} / ${data.flavor}` : data.flowerOption;
            document.getElementById('d-total').innerText = `¥${data.totalPrice}`;
            
            document.getElementById('d-sender').innerHTML = data.sender ? `${data.sender.name}<br>${data.sender.phone}` : "N/A";
            document.getElementById('d-receiver').innerHTML = data.receiver ? `${data.receiver.name}<br>${data.receiver.phone}` : "N/A";
            document.getElementById('d-addr').innerText = data.delivery ? data.delivery.address : "N/A";
            document.getElementById('d-date').innerText = data.delivery ? data.delivery.date : "N/A";
            document.getElementById('d-time').innerText = data.delivery ? data.delivery.time : "N/A";
            document.getElementById('d-msg').innerText = data.delivery ? (data.delivery.message || "-") : "-";
            
            const receipt = document.getElementById('d-img-receipt');
            const dlBtn = document.getElementById('d-download-btn');
            if (data.receiptUrl) { receipt.src = data.receiptUrl; dlBtn.href = data.receiptUrl; dlBtn.classList.remove('hidden'); } 
            else { receipt.src = "https://via.placeholder.com/300x400?text=No+Slip"; dlBtn.classList.add('hidden'); }
            
            document.getElementById('detailModal').classList.remove('hidden');
        };

        window.closeDetailModal = () => document.getElementById('detailModal').classList.add('hidden');
        window.approve = id => updateDoc(doc(db, "orders", id), { status: 'Approved' });
        window.del = id => { if(confirm("Remove?")) deleteDoc(doc(db, "orders", id)); };
    </script>
</body>
</html>
